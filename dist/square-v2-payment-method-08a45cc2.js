"use strict";(self.webpackJsonpCheckout=self.webpackJsonpCheckout||[]).push([[7516],{18739:(e,t,n)=>{n.d(t,{SquareV2PaymentMethod:()=>$});var r,i,a,o=n(31635),s=n(38589),d=n(9099),c=n(3879),u=n(89965),l=n(96095);class m extends Error{constructor(e){var t;super(e||"An unexpected error has occurred."),this.name="StandardError",this.type="standard",t=new.target.prototype,Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,"function"==typeof Error.captureStackTrace?Error.captureStackTrace(this,new.target):this.stack=new Error(this.message).stack}}class h extends m{constructor(e,t,n){super(n||"Payment cannot be processed for this order, please select another payment method"),this.type="custom_provider_execute_error",this.name=t,this.subtype=e}}function p(e,t){if(null==e)throw t?t():new Error("An unexpected error has occurred.");return e}(a=r||(r={}))[a.CheckoutButtonNotInitialized=0]="CheckoutButtonNotInitialized",a[a.CustomerNotInitialized=1]="CustomerNotInitialized",a[a.PaymentNotInitialized=2]="PaymentNotInitialized",a[a.ShippingNotInitialized=3]="ShippingNotInitialized",a[a.SpamProtectionNotInitialized=4]="SpamProtectionNotInitialized";class y extends m{constructor(e){super(function(e){switch(e){case r.CustomerNotInitialized:return"Unable to proceed because the customer step of checkout has not been initialized.";case r.PaymentNotInitialized:return"Unable to proceed because the payment step of checkout has not been initialized.";case r.ShippingNotInitialized:return"Unable to proceed because the shipping step of checkout has not been initialized.";case r.SpamProtectionNotInitialized:return"Unable to proceed because the checkout spam protection has not been initialized.";default:return"Unable to proceed because the required component has not been initialized."}}(e)),this.subtype=e,this.name="NotInitializedError",this.type="not_initialized"}}!function(e){e.CHARGE="CHARGE",e.STORE="STORE"}(i||(i={}));var f=function(e,t,n,r){return new(n||(n=Promise))((function(i,a){function o(e){try{d(r.next(e))}catch(e){a(e)}}function s(e){try{d(r.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,s)}d((r=r.apply(e,t||[])).next())}))};class v{constructor(e,t){this._scriptLoader=e,this._paymentIntegrationService=t}initialize({testMode:e,applicationId:t,locationId:n}){return f(this,void 0,void 0,(function*(){const r=yield this._scriptLoader.load(e);this._payments=r.payments(t,n)}))}deinitialize(){return f(this,void 0,void 0,(function*(){this._formValidationSubscription&&this._formValidationSubscription.unsubscribe(),this._card&&(yield this._card.destroy()),this._formValidationSubscription=void 0,this._card=void 0,this._payments=void 0}))}initializeCard({containerId:e,style:t,onValidationChange:n}){return f(this,void 0,void 0,(function*(){const{postalCode:r}=this._paymentIntegrationService.getState().getBillingAddress()||{};this._card=yield this._getPayments().card(),yield this._card.attach(`#${e}`);try{yield this._card.configure({postalCode:r,style:t})}catch(e){}n&&(this._formValidationSubscription=this._subscribeToFormValidation(this._card,n))}))}tokenize(){return f(this,void 0,void 0,(function*(){const e=yield this._getCard().tokenize();if("OK"!==e.status||!e.token){let t=`Tokenization failed with status: ${e.status}`;throw e.errors&&(t+=` and errors: ${JSON.stringify(e.errors)}`),new h("payment.errors.card_error","SquareV2TokenizationError",t)}return e.token}))}verifyBuyer(e,t){return f(this,void 0,void 0,(function*(){return t===i.CHARGE?this._chargeVerifyBuyer(e):this._storeVerifyBuyer(e)}))}_getPayments(){return p(this._payments,(()=>new y(r.PaymentNotInitialized)))}_subscribeToFormValidation(e,t){const n=["cardNumber","cvv"],r=new Set(n),i=["focusClassAdded","focusClassRemoved","errorClassAdded","errorClassRemoved","cardBrandChanged","postalCodeChanged"].map((t=>(0,d.R)(e,t)));return(0,c.h)(...i).pipe((0,u.T)((e=>{const{detail:{field:t,currentState:{isCompletelyValid:i}}}=e;return n.includes(t)&&r[i?"delete":"add"](t),0===r.size})),(0,l.F)()).subscribe(t)}_getCard(){return p(this._card,(()=>new y(r.PaymentNotInitialized)))}_mapToSquareBillingContact({firstName:e,lastName:t,address1:n,address2:r,city:i,stateOrProvinceCode:a,postalCode:o,countryCode:s,email:d,phone:c}){return{givenName:e,familyName:t,addressLines:[n,r],city:i,state:a,postalCode:o,countryCode:s,email:d,phone:c}}_chargeVerifyBuyer(e){return f(this,void 0,void 0,(function*(){const{getCheckoutOrThrow:t,getBillingAddressOrThrow:n}=this._paymentIntegrationService.getState(),{outstandingBalance:r,cart:a}=t(),o={amount:r.toString(),billingContact:this._mapToSquareBillingContact(n()),currencyCode:a.currency.code,intent:i.CHARGE},s=yield this._getPayments().verifyBuyer(e,o);return s?s.token:""}))}_storeVerifyBuyer(e){return f(this,void 0,void 0,(function*(){const{getBillingAddressOrThrow:t}=this._paymentIntegrationService.getState(),n={billingContact:this._mapToSquareBillingContact(t()),intent:i.STORE},r=yield this._getPayments().verifyBuyer(e,n);return r?r.token:""}))}}class g extends m{constructor(e){super(e||"Invalid arguments have been provided."),this.name="InvalidArgumentError",this.type="invalid_argument"}}const b={body:{},headers:{},status:0};class _ extends m{constructor(e,{message:t,errors:n}={}){const{body:r,headers:i,status:a}=e||b;super(t||"An unexpected error has occurred."),this.name="RequestError",this.type="request",this.body=r,this.headers=i,this.status=a,this.errors=n||[]}}class I extends _{constructor(e){super(e,{message:"There is a problem processing your payment. Please try again later."}),this.name="PaymentMethodInvalidError",this.type="payment_method_invalid"}}class E extends g{constructor(e){let t="Unable to submit payment for the order because the payload is invalid.";e&&(t=`${t} Make sure the following fields are provided correctly: ${e.join(", ")}.`),super(t),this.name="PaymentArgumentInvalidError"}}class S extends m{constructor(){super("The current order does not need to be finalized at this stage."),this.name="OrderFinalizationNotRequiredError",this.type="order_finalization_not_required"}}var C,w=function(e,t,n,r){return new(n||(n=Promise))((function(i,a){function o(e){try{d(r.next(e))}catch(e){a(e)}}function s(e){try{d(r.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,s)}d((r=r.apply(e,t||[])).next())}))};class k{constructor(e,t){this._paymentIntegrationService=e,this._squareV2PaymentProcessor=t}initialize(e){var t;return w(this,void 0,void 0,(function*(){if(!(null===(t=null==e?void 0:e.squarev2)||void 0===t?void 0:t.containerId))throw new g('Unable to proceed because "containerId" argument is not provided.');const{methodId:n,squarev2:r}=e,{config:{testMode:i},initializationData:a}=this._paymentIntegrationService.getState().getPaymentMethodOrThrow(n),{applicationId:o,locationId:s}=a||{};if(!o)throw new I;yield this._squareV2PaymentProcessor.initialize({applicationId:o,locationId:s,testMode:i}),yield this._squareV2PaymentProcessor.initializeCard(r)}))}execute({payment:e}){return w(this,void 0,void 0,(function*(){if(!e)throw new E(["payment"]);const{methodId:t,paymentData:n}=e,{shouldSaveInstrument:r,shouldSetAsDefaultInstrument:i}="object"!=typeof(a=n)||null===a||void 0!==a.shouldSaveInstrument&&"boolean"!=typeof a.shouldSaveInstrument||void 0!==a.shouldSetAsDefaultInstrument&&"boolean"!=typeof a.shouldSetAsDefaultInstrument?{shouldSaveInstrument:!1,shouldSetAsDefaultInstrument:!1}:n;var a;yield this._paymentIntegrationService.submitOrder();const o=n&&function(e){return Boolean(e.instrumentId)}(n)?yield this._getVaultedInstrumentPayload(t,n):yield this._getCardPayload(t,r);yield this._paymentIntegrationService.submitPayment(Object.assign(Object.assign({},e),{paymentData:{formattedPayload:Object.assign(Object.assign({},o),{vault_payment_instrument:r||!1,set_as_default_stored_instrument:i||!1})}}))}))}finalize(){return Promise.reject(new S)}deinitialize(){return this._squareV2PaymentProcessor.deinitialize()}shouldVerify(){const{features:e}=this._paymentIntegrationService.getState().getStoreConfigOrThrow().checkoutSettings;return e["PROJECT-3828.add_3ds_support_on_squarev2"]}_getCardPayload(e,t){return w(this,void 0,void 0,(function*(){const{getPaymentMethodOrThrow:n}=this._paymentIntegrationService.getState(),{initializationData:r}=n(e),a=yield this._squareV2PaymentProcessor.tokenize();if(r&&"isSquareV2ApiV2Enabled"in r?!r.isSquareV2ApiV2Enabled:!this.shouldVerify())return{credit_card_token:{token:a}};let o={nonce:a,token:yield this._squareV2PaymentProcessor.verifyBuyer(a,i.CHARGE)};if(t){const e=yield this._squareV2PaymentProcessor.tokenize();o=Object.assign(Object.assign({},o),{store_card_nonce:e,store_card_token:yield this._squareV2PaymentProcessor.verifyBuyer(e,i.STORE)})}return{credit_card_token:{token:JSON.stringify(o)}}}))}_getVaultedInstrumentPayload(e,t){return w(this,void 0,void 0,(function*(){const{getPaymentMethodOrThrow:n}=this._paymentIntegrationService.getState(),{initializationData:r}=n(e),{instrumentId:a}=t,o=(r&&"isSquareV2ApiV2Enabled"in r?r.isSquareV2ApiV2Enabled:this.shouldVerify())?yield this._squareV2PaymentProcessor.verifyBuyer(yield this._getSquareCardIdOrThrow(e,a),i.CHARGE):void 0;return{bigpay_token:Object.assign({token:a},o&&{three_d_secure:{token:o}})}}))}_getSquareCardIdOrThrow(e,t){return w(this,void 0,void 0,(function*(){const n=yield this._paymentIntegrationService.loadPaymentMethod(e,{params:{method:e,bigpayToken:t}}),{initializationData:r}=n.getPaymentMethodOrThrow(e),{cardId:i}=r||{};if(!i)throw new E(["cardId"]);return i}))}}class N extends m{constructor(e){super(e||"Unable to proceed because the client library of a payment method is not loaded or ready to be used."),this.name="PaymentMethodClientUnavailableError",this.type="payment_method_client_unavailable"}}!function(e){e.LIVE="https://web.squarecdn.com/v1/square.js",e.SANDBOX="https://sandbox.web.squarecdn.com/v1/square.js"}(C||(C={}));class x{constructor(e){this._scriptLoader=e}load(e=!1){return t=this,r=function*(){return yield this._scriptLoader.loadScript(e?C.SANDBOX:C.LIVE),function(){if(!function(e){return"Square"in e}(window))throw new N}(),window.Square},new((n=void 0)||(n=Promise))((function(e,i){function a(e){try{s(r.next(e))}catch(e){i(e)}}function o(e){try{s(r.throw(e))}catch(e){i(e)}}function s(t){var r;t.done?e(t.value):(r=t.value,r instanceof n?r:new n((function(e){e(r)}))).then(a,o)}s((r=r.apply(t,[])).next())}));var t,n,r}}const P=(z=e=>new k(e,new v(new x((0,s.vQ)()),e)),A=[{id:"squarev2"}],Object.assign(z,{resolveIds:A}));var z,A,V=n(69440),q=n(70355),O=n(59713),T=n(19285),D=n(3375),B=n.n(D),R=n(62677),M=n(40646),j=n(66960),H=n(91182);const U=({checkoutService:e,checkoutState:t,containerId:n,deinitializePayment:r,initializePayment:i,method:a})=>{var o;const[s,d]=(0,q.useState)(!1),[c,u]=(0,q.useState)(void 0),{getCustomer:l,getInstruments:m}=t.data,h=!(null===(o=l())||void 0===o?void 0:o.isGuest)&&Boolean(a.config.isVaultingEnabled);(0,q.useEffect)((()=>{h&&e.loadInstruments()}),[e,h]);const p=(0,q.useMemo)((()=>m(a)||[]),[m,a]),y=h&&p.length>0,f=!y||s,v=(0,q.useCallback)((()=>{if(!s&&p.length>0){return(p.find((e=>e.defaultInstrument))||p[0]).bigpayToken}}),[p,s]);(0,q.useEffect)((()=>{const e=v()||void 0;u(e)}),[v,p]);const{setFieldValue:g}=(0,j.N)().paymentForm,{isLoadingInstruments:b}=t.statuses;return q.createElement(H.A,{"data-test":"squarev2_loading_overlay",hideContentWhenLoading:!0,isLoading:b()},q.createElement("div",{className:"paymentMethod--hosted"},y&&q.createElement(R.A,{instruments:p,onDeleteInstrument:e=>{0===p.length?(d(!0),u(void 0),g("instrumentId","")):c===e&&(u(v()),g("instrumentId",v()))},onSelectInstrument:e=>{d(!1),u(e)},onUseNewInstrument:()=>{d(!0),u(void 0),r(),i()},selectedInstrumentId:c||v()}),q.createElement("div",{className:B()("widget",`widget--${a.id}`,"payment-widget"),"data-test":n,style:{display:f?void 0:"none"},tabIndex:-1},q.createElement("div",{"data-test":"squarev2_placeholder_form",style:{display:"none"}},q.createElement("div",{className:"form-field"},q.createElement("div",{className:"form-label optimizedCheckout-form-label",id:"messageIsDefault"}),q.createElement("div",{className:"form-input optimizedCheckout-form-input",id:"inputIsDefault"})),q.createElement("div",{className:"form-field"},q.createElement("div",{className:"form-input optimizedCheckout-form-input form-input--focus optimizedCheckout-form-input--focus",id:"inputIsFocus"})),q.createElement("div",{className:"form-field form-field--error"},q.createElement("div",{className:"form-inlineMessage",id:"messageIsError"}),q.createElement("div",{className:"form-input optimizedCheckout-form-input",id:"inputIsError"}))),q.createElement("div",{id:n})),h&&q.createElement(M.A,{instrumentId:c,instruments:p})))},$=(0,T.A)((({method:e,checkoutService:t,checkoutState:n})=>{const r=(e,t)=>{const n=document.querySelector(`#${e}`);if(!n)throw new Error(`Unable to retrieve input styles as the provided container ID "${e}" is not valid.`);return(0,O.A)(n,t)},i=(0,q.useCallback)((()=>{const e=["backgroundColor","borderColor","borderRadius","borderWidth","color","fontSize","fontWeight"];return{default:{message:r("messageIsDefault",["color"]),input:r("inputIsDefault",e)},focus:{input:r("inputIsFocus",(0,V.difference)(e,["borderRadius"]))},error:{message:r("messageIsError",["color"]),input:r("inputIsError",["borderColor","borderWidth","color"])}}}),[]),a=(0,q.useCallback)((e=>{const t=e.default.input,{borderColor:n,borderRadius:r,borderWidth:i}=t,a=(0,o.__rest)(t,["borderColor","borderRadius","borderWidth"]),s=e.focus.input,{borderColor:d,borderWidth:c}=s,u=(0,o.__rest)(s,["borderColor","borderWidth"]),{borderColor:l,borderWidth:m,color:h}=e.error.input;return{input:a,"input.is-focus":Object.assign({},u),"input.is-error":{color:h},".input-container":{borderColor:n,borderRadius:r,borderWidth:i},".input-container.is-focus":{borderColor:d,borderWidth:c},".input-container.is-error":{borderColor:l,borderWidth:m},".message-text":{color:e.default.message.color},".message-icon":{color:e.default.message.color},".message-text.is-error":{color:e.error.message.color},".message-icon.is-error":{color:e.error.message.color}}}),[]),s="squarev2_payment_element_container",d=(0,q.useCallback)((()=>(0,o.__awaiter)(void 0,void 0,void 0,(function*(){let n;try{n=a(i())}catch(e){}yield t.initializePayment({gatewayId:e.gateway,methodId:e.id,integrations:[P],squarev2:{containerId:s,style:n}})}))),[t,i,a,e.gateway,e.id]),c=(0,q.useCallback)((()=>(0,o.__awaiter)(void 0,void 0,void 0,(function*(){yield t.deinitializePayment({gatewayId:e.gateway,methodId:e.id})}))),[t,e.gateway,e.id]);return(0,q.useEffect)((()=>(d(),()=>{c()})),[c,d]),q.createElement(U,{checkoutService:t,checkoutState:n,containerId:s,deinitializePayment:c,initializePayment:d,method:e})}),[{id:"squarev2"}])},29905:(e,t,n)=>{function r(e){switch(e){case"amex":case"american_express":return"american-express";case"diners":case"diners_club":return"diners-club";default:return e}}n.d(t,{A:()=>r})},62677:(e,t,n)=>{n.d(t,{A:()=>w});var r=n(70355),i=n(49655),a=n(24750),o=n(40052),s=n(35393),d=n(97834),c=n(22437),u=n(3375),l=n.n(u),m=n(52921),h=n.n(m),p=n(69440),y=n(86516),f=n(47237),v=n(29905);const g=({className:e,instrument:t,testId:n,shouldHideExpiryDate:a=!1,onClick:o})=>{var s;const d=(0,v.A)(t.brand),u=h().getTypeInfo(d),m=!(0,c.expirationDate)({month:t.expiryMonth,year:t.expiryYear}).isValid;return r.createElement("button",{className:e,"data-test":n,onClick:o,type:"button"},r.createElement("div",{className:l()("instrumentSelect-details",{"instrumentSelect-details--expired":m})},r.createElement(y.A,{cardType:d}),r.createElement("div",{className:"instrumentSelect-card","data-test":`${null!=n?n:""}-last4`},u?r.createElement(i.A,{data:{cardTitle:null!==(s=u.niceType)&&void 0!==s?s:"",endingIn:t.last4},id:"payment.instrument_ending_in_text"}):r.createElement(i.A,{data:{endingIn:t.last4},id:"payment.instrument_default_ending_in_text"})),!a&&r.createElement("div",{className:l()("instrumentSelect-expiry",{"instrumentSelect-expiry--expired":m}),"data-test":`${n||""}-expiry`},m?r.createElement(i.A,{data:{expiryDate:`${t.expiryMonth}/${t.expiryYear}`},id:"payment.instrument_expired_text"}):r.createElement(i.A,{data:{expiryDate:`${t.expiryMonth}/${t.expiryYear}`},id:"payment.instrument_expires_text"}))))},b=({instrument:e,shouldHideExpiryDate:t=!1,onClick:n=p.noop})=>{const i=(0,r.useCallback)((()=>{n(e.bigpayToken)}),[n,e]);return r.createElement(g,{instrument:e,onClick:i,shouldHideExpiryDate:t,testId:"instrument-select-option"})},_=({className:e,testId:t,onClick:n=p.noop})=>r.createElement("button",{className:e,"data-test":t,onClick:n,type:"button"},r.createElement("div",{className:"instrumentSelect-details instrumentSelect-details--addNew"},r.createElement(y.A,null),r.createElement("div",{className:"instrumentSelect-card"},r.createElement(i.A,{id:"payment.instrument_add_card_action"})))),I=({instruments:e,selectedInstrumentId:t,shouldHideExpiryDate:n=!1,onSelectInstrument:i,onUseNewInstrument:a})=>r.createElement("ul",{className:"instrumentSelect-dropdownMenu instrumentSelect-dropdownMenuNext dropdown-menu","data-test":"instrument-select-menu"},e.map((e=>r.createElement("li",{className:l()("instrumentSelect-option dropdown-menu-item",{"instrumentSelect-option--selected":e.bigpayToken===t}),key:e.bigpayToken},r.createElement(b,{instrument:e,onClick:i,shouldHideExpiryDate:n,testId:"instrument-select-option"})))),r.createElement("li",{className:"instrumentSelect-option instrumentSelect-option--addNew dropdown-menu-item"},r.createElement(_,{onClick:a,testId:"instrument-select-option-use-new"}))),E=({instrument:e,shouldHideExpiryDate:t=!1,testId:n,onClick:i})=>e?r.createElement(g,{className:"instrumentSelect-button optimizedCheckout-form-select dropdown-button form-input",instrument:e,onClick:i,shouldHideExpiryDate:t,testId:n}):r.createElement(_,{className:"instrumentSelect-button optimizedCheckout-form-select dropdown-button form-input",testId:n}),S=({field:e,form:t,instruments:n,onSelectInstrument:i,onUseNewInstrument:a,selectedInstrumentId:o,shouldHideExpiryDate:s=!1})=>{const d=(0,r.useRef)(o),c=(0,r.useCallback)(((n="")=>{t.setFieldValue(e.name,n)}),[t,e.name]);(0,r.useEffect)((()=>(setTimeout((()=>c(o))),()=>{""===e.value&&void 0!==o&&c()})),[]),(0,r.useEffect)((()=>{d.current!==o&&setTimeout((()=>c(o))),d.current=o}),[o,c]);const u=(0,p.find)(n,{bigpayToken:o});return r.createElement("div",{className:"instrumentSelect"},r.createElement(f.A,{dropdown:r.createElement(I,{instruments:n,onSelectInstrument:i,onUseNewInstrument:a,selectedInstrumentId:o,shouldHideExpiryDate:s})},r.createElement(E,{instrument:u,shouldHideExpiryDate:s,testId:"instrument-select"}),r.createElement("input",Object.assign({type:"hidden"},e))))};var C=n(3701);const w=(0,r.memo)((({instruments:e,onDeleteInstrument:t,onSelectInstrument:n,onUseNewInstrument:c,selectedInstrumentId:u,shouldHideExpiryDate:l=!1,validateInstrument:m=null})=>{const h=(0,r.useCallback)((t=>r.createElement(S,Object.assign({},t,{instruments:e,onSelectInstrument:n,onUseNewInstrument:c,selectedInstrumentId:u,shouldHideExpiryDate:l}))),[e,n,c,u,l]),p=(0,r.useCallback)((n=>r.createElement(C.A,Object.assign({instruments:e,onDeleteInstrument:t},n))),[e,t]);return r.createElement(a.A,{additionalClassName:"instrumentFieldset",legend:r.createElement(o.A,{hidden:!0},r.createElement(i.A,{id:"payment.instrument_text"}))},r.createElement(s.A,{modal:p},(({onClick:e})=>r.createElement("button",{className:"instrumentModal-trigger",onClick:e,type:"button"},r.createElement(i.A,{id:"payment.instrument_manage_button"})))),r.createElement(d.A,{name:"instrumentId",render:h}),r.createElement("div",{style:{display:u?void 0:"none"}},m))}))}}]);
//# sourceMappingURL=square-v2-payment-method-08a45cc2.js.map